name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci
      - run: npm run lint
        continue-on-error: true
      - run: npm run build

  backend:
    runs-on: ubuntu-latest

    # ★Postgres をCI内に立てる（Integrationテスト用）
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: invoices_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d invoices_test"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    # ★Program.cs の分岐＆接続文字列に合わせて上書き
    env:
      ASPNETCORE_ENVIRONMENT: Testing
      SEED_DEMO_DATA: "true"
      ConnectionStrings__DefaultConnection: Host=localhost;Port=5432;Database=invoices_test;Username=postgres;Password=postgres

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # 任意：DBが起動済みになるまで少し待つ（healthcheckがあるので基本不要だが保険）
      - name: Wait for Postgres
        run: |
          for i in {1..30}; do
            pg_isready -h localhost -p 5432 -U postgres -d invoices_test && exit 0
            sleep 2
          done
          echo "Postgres is not ready"
          exit 1

      - run: dotnet restore backend/InvoiceSystem.Tests/InvoiceSystem.Tests.csproj
      - run: dotnet build   backend/InvoiceSystem.Tests/InvoiceSystem.Tests.csproj -c Release --no-restore
      - run: dotnet test    backend/InvoiceSystem.Tests/InvoiceSystem.Tests.csproj -c Release --no-build


