# Architecture Overview

Invoice Management System (Lite)

----

## 1. 本ドキュメントの目的

本ドキュメントは、
Invoice Management System (Lite) における設計方針・構成意図を整理し、
以下を明確にすることを目的としています。

- なぜこの構成・設計にしたのか
- 業務アプリとして何を重視したか
- Lite 版として意図的に省略している点

※ 実装詳細ではなく 設計判断の背景 を中心に記載します。

## 2. システム全体構成
```bash
[ Frontend (Next.js) ]
        |
        |  REST API (JWT)
        |
[ Backend API (ASP.NET Core) ]
        |
        |  ORM (EF Core)
        |
[ PostgreSQL ]
```
### 構成の特徴
- フロントエンド / バックエンド完全分離
- API ベース設計による責務の明確化
- Web 業務アプリとして一般的な三層構成を採用

## 3. ユーザー区分と責務分離
本システムでは 2 種類のユーザー を想定しています。
### 管理者（Admin）
- 全会員・全請求書・全入金を管理
- 請求書発行・編集
- 入金登録・入金割当
- 売上・回収状況の集計確認

### 会員（Member）
- 自身の請求書のみ参照可能
- 支払状況の確認
- 管理操作は不可

👉
権限による画面・API制御 を前提とした設計としています。

## 4. 画面遷移設計（状態遷移図）

画面遷移は以下の考え方で設計しています。
- ログイン後の起点を明確化
- 管理者：管理者ダッシュボード
- 会員：会員用ダッシュボード
- 一覧 → 詳細 → 操作 → 一覧へ戻る、の業務UI基本導線
- 削除・登録後の戻り先を統一し、操作ミスを防止

※ 詳細な遷移は /docs 配下の 状態遷移図 を参照してください。

## 5. データベース設計（ER図）
### 設計方針
- 業務で起こり得る状態変化を正規化して表現
- 一部入金・複数請求対応を最初から考慮
- 集計は保持せず、必要に応じて算出

### 主なテーブル構成

### MEMBERS
- 管理者・会員を統合管理
- Role により権限を判定

### INVOICES
- 請求書の基本情報を保持
- ステータスは InvoiceStatus により管理

### PAYMENTS
- 実際の入金データを保持
- CSV取込・手動登録の両方を想定

### PAYMENT_ALLOCATIONS（重要）
- 1件の入金を複数の請求書に割当可能
- 一部入金・複数請求対応の中核テーブル

### INVOICE_STATUS
- 未入金 / 一部入金 / 入金済み を定義
- 表示順・期限超過判定用フラグを保持

### REMINDER_HISTORIES
- 催促の履歴を保持
- 業務ログとして独立管理

※ 詳細な関係性は ER図 を参照してください。

## 6. 請求ステータス自動判定ロジック

本システムでは、
請求書に対する入金状況からステータスを自動判定 します。

### 判定方針
- 請求金額合計
- 割当済み入金額合計
を比較し、以下を判定：

| 状態   | 条件              |
| ---- | --------------- |
| 未入金  | 入金合計 = 0        |
| 一部入金 | 0 < 入金合計 < 請求金額 |
| 入金済み | 入金合計 ≥ 請求金額     |

👉
ステータスを直接更新せず、ロジックで一元管理 することで
データ不整合を防止しています。

## 7. レイヤードアーキテクチャ

バックエンドは以下の構成を採用しています。
```graphql
Domain
 └─ エンティティ / Enum / ルール

Application
 └─ ユースケース / サービス / DTO

Infrastructure
 └─ DB / 外部サービス / 実装詳細
```

### 意図
- 業務ロジックを Domain / Application に集約
- DB・外部依存を Infrastructure に隔離
- 将来的な変更・拡張に耐えやすい構成

## 8. Lite 版として省略している点
本リポジトリは Lite 版 として、以下を意図的に省略しています。
- 月次締め処理
- 高度な権限制御（多段ロール）
- 承認フロー
- 外部決済サービス連携
- メール自動送信

👉
コア業務（請求・入金・集計）に集中 するための判断です。

## 9. 想定ユースケース
- 中小規模事業者向けの請求・入金管理
- Excel 管理からの移行イメージ
- 実務に近い業務フローの再現

## 10. まとめ

本システムは
「学習用アプリ」ではなく「業務アプリ設計の再現」 を目的としています。
- 状態変化を意識した設計
- 一部入金・割当対応
- 実務視点での画面遷移・集計

を重視した構成としています。
